---
- name: configure jenkins variables
  include_vars: "{{ jenkins_version }}.yml"
  tags:
  - jenkins-plugins

- import_tasks: redhat.yml
- import_tasks: debian.yml

- name: ensure Jenkins is started
  service:
    name: jenkins
    state: started
    enabled: yes

- name: create jenkins-cli path
  file:
    path: "{{ jenkins_cli_path }}/"
    state: directory

- name: wait for Jenkins API to response properly
  uri:
    url: "{{ jenkins_cli_url }}/api/json"
    return_content: yes
  register: webpage
  until: webpage.status in [ 403, 200 ]
  failed_when: webpage.status not in [ 403, 200 ]
  retries: 10
  delay: 10

- name: install plugins
  jenkins_plugin:
    name: "{{ item.name }}"
    url: "{{ jenkins_cli_url }}"
    state: "{{ item.state | default(jenkins_plugins_state) }}"
    version: "{{ item.version | default(omit) }}"
    with_dependencies: "{{ item.with_dependencies | default(omit) }}"
  loop: "{{ jenkins_plugins }}"
